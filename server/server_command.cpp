#include "server.h"
#include <netinet/in.h>
static void SetIntData2DataBlock(void *data,int intData,int *dataSize);
static void SetCharData2DataBlock(void *data,char charData,int *dataSize);

int readNum = 0; //読み込んだ戦闘機
int bullet_num = 0;
/*****************************************************************
????	: ExecuteCommand
???	: ??????????????????????????????
		  ??????????????????????
????	: char	command		: ???????
		  int	pos			: ??????????????????????????
????	: ?????????????????????????????????0???????
		  ?????????1?????
*****************************************************************/
int ExecuteCommand(char command,int pos)
{
    unsigned char	data[MAX_DATA];
    int data2[MAX_CLIENTS];
    int			dataSize,intData;
    int			endFlag = 1;


    switch(command){

        case PLAYERDATA_COMMAND:{
            dataSize = 0;
            Player *p = (Player*)malloc(sizeof(Player));
            RecvData(pos, p, sizeof(Player)); //Playerの情報を受け取る
            player[pos] = *p; //Playerの情報を格納
            free(p);
        }
            
            readNum |= (1 << pos); //集まったクライアント番号の判定 1101でclient[2]以外集まっている
            if(readNum == (15>>(4-gClientNum))){
			    SetCharData2DataBlock(data2,command,&dataSize);
			    SendData(ALL_CLIENTS,data2,dataSize);

                SendData(ALL_CLIENTS,player,sizeof(Player)*gClientNum); //Player情報を全員に送る

                readNum = 0;
            }
            
            break;
        case BULLETDATA_COMMAND:
            BULLET b;
            RecvData(pos, &b, sizeof(BULLET));
            array_bullet[bullet_num] = b;
            bullet_num ++;
            break;
	    case END_COMMAND:
			dataSize = 0;
			/* ??????????????? */
			SetCharData2DataBlock(data,command,&dataSize);

			/* ???????????????? */
			SendData(ALL_CLIENTS,data,dataSize);

			endFlag = 0;
			break;
	  default:
			/* ?????????????????????? */
			fprintf(stderr,"0x%02x is not command!\n",command);
    }
    return endFlag;
}

/*****
static
*****/
/*****************************************************************
????	: SetIntData2DataBlock
???	: int ?????????????????????????????????????
????	: void		*data		: ??????????
		  int		intData		: ???????????????
		  int		*dataSize	: ???????????????????????
????	: ???
*****************************************************************/
static void SetIntData2DataBlock(void *data,int intData,int *dataSize)
{
    int tmp;

    /* ??????????????? */
    assert(data!=NULL);
    assert(0<=(*dataSize));

    tmp = htonl(intData);

    /* int ???????????????????????????????????? */
    memcpy(data + (*dataSize),&tmp,sizeof(int));
    /* ????????????????? */
    (*dataSize) += sizeof(int);
}

/*****************************************************************
????	: SetCharData2DataBlock
???	: char ?????????????????????????????????????
????	: void		*data		: ??????????
		  int		intData		: ???????????????
		  int		*dataSize	: ???????????????????????
????	: ???
*****************************************************************/
static void SetCharData2DataBlock(void *data,char charData,int *dataSize)
{
    /* ??????????????? */
    assert(data!=NULL);
    assert(0<=(*dataSize));

    /* int ???????????????????????????????????? */
    *(char *)(data + (*dataSize)) = charData;
    /* ????????????????? */
    (*dataSize) += sizeof(char);
}

